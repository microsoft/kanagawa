name: Build and Test Targets Template

on:
  workflow_call:
    inputs:
      build-targets:
        description: 'Space-separated list of CMake targets to build'
        required: true
        type: string
      test-targets:
        description: 'Space-separated list of CMake test targets to build (optional - will run after build-targets)'
        required: false
        type: string
        default: ''
      artifact-name:
        description: 'Name for the artifact to upload (optional - if not provided, no artifact will be uploaded)'
        required: false
        type: string
        default: ''
      artifact-path:
        description: 'Path to files to include in artifact'
        required: false
        type: string
        default: 'build-ci/dist/bin/**'
      cmake-build-type:
        description: 'CMake build type'
        required: false
        type: string
        default: 'RelWithDebInfo'
      runs-on:
        description: 'Runner type (ubuntu-24.04, macos-14, etc.)'
        required: false
        type: string
        default: 'ubuntu-24.04'
      boost-platform-version:
        description: 'Platform version for Boost installation (24.04 for Ubuntu, 14 for macOS)'
        required: false
        type: string
        default: '24.04'
      install-riscv64-gcc:
        description: 'Install RISC-V 64-bit GCC toolchain'
        required: false
        type: boolean
        default: false
      install-pandoc:
        description: 'Install pandoc using pandoc/actions/setup'
        required: false
        type: boolean
        default: false
      install-rust:
        description: 'Install Rust toolchain using actions-rust-lang/setup-rust-toolchain'
        required: false
        type: boolean
        default: false
      install-svgbob:
        description: 'Install svgbob_cli using cargo'
        required: false
        type: boolean
        default: false
      heavy-parallel-jobs:
        description: 'Number of parallel jobs for heavy compilation tasks'
        required: false
        type: number
        default: 2
      extra-cmake-args:
        description: 'Extra args appended to CMake configure'
        required: false
        type: string
        default: ''
      fetch-depth:
        description: 'Checkout fetch-depth (0 to fetch all history/tags)'
        required: false
        type: string
        default: '0'
jobs:
  build:
    runs-on: ${{ inputs.runs-on }}

    env:
      CMAKE_BUILD_TYPE: ${{ inputs.cmake-build-type }}
      CCACHE_COMPILERCHECK: content
      CCACHE_CPP2: "true"
      CCACHE_BASEDIR: ${{ github.workspace }}
      CCACHE_MAXSIZE: 2G
      BOOST_VERSION: "1.88.0"

    steps:
      - name: Set build dirs
        shell: bash
        run: |
          echo "BUILD_DIR=$GITHUB_WORKSPACE/build-ci" >> "$GITHUB_ENV"
          echo "CCACHE_DIR=$RUNNER_TEMP/.ccache" >> "$GITHUB_ENV"

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: ${{ inputs.fetch-depth }}
          submodules: false

      - name: Shallow init CIRCT (recursive, depth=1)
        shell: bash
        run: |
          git submodule sync --recursive
          git -c protocol.version=2 \
              submodule update --init --recursive --depth 1

      # Free up some disk space - this is a major constraint on GitHub-hosted runners
      - name: Free disk space
        if: runner.os == 'Linux'
        uses: jlumbroso/free-disk-space@v1.3.1
        with:
          android: true
          dotnet: true
          haskell: false   # keep
          docker-images: true
          large-packages: true
          tool-cache: false

      # Derive the CIRCT submodule commit
      - name: Get CIRCT submodule SHA
        id: circt
        shell: bash
        run: |
          CIRCT_SHA=$(git ls-tree HEAD thirdparty/circt | awk '{print $3}')
          if [ -z "$CIRCT_SHA" ]; then
            echo "Could not determine CIRCT SHA. Check submodule path." >&2
            exit 1
          fi
          echo "sha=$CIRCT_SHA" >> "$GITHUB_OUTPUT"

      # Detect the C++ compiler & version (keeps cache safe across toolchain updates)
      - name: Detect C++ compiler
        id: ccinfo
        shell: bash
        run: |
          if command -v clang++ >/dev/null 2>&1; then
            CC_ID=clang
            CC_VER=$(clang++ --version | head -n1 | tr ' ' '_')
          elif command -v g++ >/dev/null 2>&1; then
            CC_ID=gcc
            CC_VER=$(g++ -dumpfullversion 2>/dev/null || g++ -dumpversion)
          else
            echo "No C++ compiler found on PATH" >&2
            exit 1
          fi
          echo "id=$CC_ID"  >> "$GITHUB_OUTPUT"
          echo "ver=$CC_VER" >> "$GITHUB_OUTPUT"

      # Restore ccache across runs. Cache key includes compiler id+version, CIRCT sha, CMake build type, and build/cmake/circt.cmake hash.
      - name: Restore ccache
        uses: actions/cache@v4
        with:
          path: ${{ env.CCACHE_DIR }}
          key: >
            ccache-circt-${{ runner.os }}-${{ steps.ccinfo.outputs.id }}-${{ steps.ccinfo.outputs.ver }}-
            ${{
              steps.circt.outputs.sha
            }}-${{ env.CMAKE_BUILD_TYPE }}-${{ hashFiles('build/cmake/circt.cmake') }}
          restore-keys: |
            ccache-circt-${{ runner.os }}-${{ steps.ccinfo.outputs.id }}-${{ steps.ccinfo.outputs.ver }}-

      - name: Install Haskell
        id: haskell
        uses: haskell-actions/setup@v2
        with:
          ghc-version: '9.6.7'
          cabal-version: '3.12.1.0'
          enable-stack: false

      - name: Cache ghcup & cabal store
        uses: actions/cache@v4
        with:
          path: |
            ~/.ghcup
            ${{ steps.haskell.outputs.cabal-store }}
          key: ${{ runner.os }}-ghc-9.6.7-cabal-3.12.1.0-${{ hashFiles('**/cabal.project*') }}
          restore-keys: |
            ${{ runner.os }}-ghc-9.6.7-cabal-3.12.1.0-

      - name: cabal update
        run: cabal update

      - name: Init ccache
        uses: hendrikmuhs/ccache-action@v1
        with:
          max-size: ${{ env.CCACHE_MAXSIZE }}
          verbose: 1

      - name: Install Verilator
        if: runner.os != 'Windows'
        uses: veryl-lang/setup-verilator@v1
        with:
          version: '5.036'

      - name: Install Boost
        id: install_boost
        uses: MarkusJx/install-boost@v2
        with:
          boost_version: ${{ env.BOOST_VERSION }}   # e.g. "1.88.0"
          platform_version: ${{ inputs.boost-platform-version }}
          boost_install_dir: ${{ runner.temp }}
          toolset: ${{ runner.os == 'Windows' && 'msvc' || runner.os == 'macOS' && 'clang' || 'gcc' }}

      - name: Install miscellaneous packages (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build pkg-config libgmp-dev

      - name: Install miscellaneous packages (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install cmake ninja pkg-config gmp

      - name: Install miscellaneous packages (Windows)
        if: runner.os == 'Windows'
        run: |
          choco install cmake ninja pkgconfiglite -y

      - name: Install pandoc
        if: ${{ inputs.install-pandoc }}
        uses: pandoc/actions/setup@v1

      - name: Install Rust toolchain
        if: ${{ inputs.install-rust }}
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable
          cache: true

      - name: Install svgbob_cli
        if: ${{ inputs.install-svgbob }}
        run: cargo install svgbob_cli --version 0.7.6

      - name: Install RISC-V 64-bit GCC toolchain
        if: ${{ inputs.install-riscv64-gcc }}
        shell: bash
        run: |
          ARCHIVE="riscv64-unknown-elf-gcc-10.1.0-2020.08.2-x86_64-linux-ubuntu14.tar.gz"
          wget "https://static.dev.sifive.com/dev-tools/freedom-tools/v2020.08/${ARCHIVE}"
          tar -xzf "${ARCHIVE}" -C "$RUNNER_TEMP"
          rm "${ARCHIVE}"
          echo "RISCV64_GCC_DIR=$RUNNER_TEMP/riscv64-unknown-elf-gcc-10.1.0-2020.08.2-x86_64-linux-ubuntu14" >> "$GITHUB_ENV"

      - name: Capture tool paths
        id: paths
        shell: bash
        run: |
          # Read BOOST_ROOT from the action OUTPUT
          BOOST_ROOT_OUT="${{ steps.install_boost.outputs.BOOST_ROOT }}"
          if [ -z "$BOOST_ROOT_OUT" ] || [ ! -d "$BOOST_ROOT_OUT" ]; then
            echo "install-boost BOOST_ROOT output missing/invalid: '$BOOST_ROOT_OUT'" >&2
            exit 1
          fi
          echo "BOOST_ROOT=$BOOST_ROOT_OUT" >> "$GITHUB_ENV"

          ver="${BOOST_VERSION:-${{ env.BOOST_VERSION }}}"
          candidates=(
            "$BOOST_ROOT_OUT/lib/cmake/Boost-$ver"
            "$BOOST_ROOT_OUT/lib64/cmake/Boost-$ver"
            "$BOOST_ROOT_OUT/share/cmake/Boost-$ver"
            "$BOOST_ROOT_OUT/lib/cmake"
            "$BOOST_ROOT_OUT/lib64/cmake"
            "$BOOST_ROOT_OUT/share/cmake"
          )

          found=""
          for d in "${candidates[@]}"; do
            if [ -f "$d/BoostConfig.cmake" ]; then
              found="$d"
              break
            fi
          done

          if [ -z "$found" ]; then
            echo "Could not locate BoostConfig.cmake under $BOOST_ROOT_OUT" >&2
            echo "Checked:" >&2
            printf "  - %s\n" "${candidates[@]}" >&2
            echo "Directory snapshot of BOOST_ROOT:" >&2
            (ls -la "$BOOST_ROOT_OUT" && echo "--- lib/cmake ---" && ls -la "$BOOST_ROOT_OUT/lib/cmake" 2>/dev/null || true) >&2
            exit 1
          fi

          echo "BOOST_DIR=$found" >> "$GITHUB_ENV"

          # ghcup & Verilator
          echo "GHCUP_DIR=$HOME/.ghcup/bin" >> "$GITHUB_ENV"

          # Verilator is only installed on non-Windows runners
          if [ "${{ runner.os }}" != "Windows" ]; then
            VERILATOR_EXE="$(command -v verilator)"
            [ -z "$VERILATOR_EXE" ] && { echo "Verilator not found"; exit 1; }
            echo "VERILATOR_EXE=$VERILATOR_EXE" >> "$GITHUB_ENV"
          fi

          # Help CMake search under BOOST_ROOT too
          echo "CMAKE_PREFIX_PATH=$BOOST_ROOT_OUT${CMAKE_PREFIX_PATH:+:$CMAKE_PREFIX_PATH}" >> "$GITHUB_ENV"

      - name: Print tool versions/paths
        shell: bash
        run: |
          ghc --version
          cabal --version
          if [ "${{ runner.os }}" != "Windows" ]; then
            verilator --version
          else
            echo "Verilator: not installed (Windows)"
          fi
          echo "BOOST_ROOT=${{ env.BOOST_ROOT }}"
          echo "BOOST_DIR=${{ env.BOOST_DIR }}"
          echo "CMAKE_PREFIX_PATH=${{ env.CMAKE_PREFIX_PATH }}"

      - name: Setup MSVC Developer Command Prompt
        if: runner.os == 'Windows'
        uses: ilammy/msvc-dev-cmd@v1

      - name: Configure (CMake Generate)
        shell: bash
        run: |
          cmake \
            -S . \
            -B "${{ env.BUILD_DIR }}" \
            -G Ninja \
            -DCMAKE_BUILD_TYPE="${{ env.CMAKE_BUILD_TYPE }}" \
            ${{ runner.os == 'Windows' && '-DCMAKE_C_COMPILER=cl -DCMAKE_CXX_COMPILER=cl' || '' }} \
            -DCMAKE_C_COMPILER_LAUNCHER=ccache \
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache \
            -DCMAKE_PREFIX_PATH="${{ env.BOOST_DIR }}:${{ env.CMAKE_PREFIX_PATH }}" \
            -DBoost_DIR="${{ env.BOOST_DIR }}" \
            -DGHCUP_DIR="${{ env.GHCUP_DIR }}" \
            ${{ runner.os != 'Windows' && format('-DVERILATOR_EXE={0}', env.VERILATOR_EXE) || '' }} \
            ${{ inputs.install-riscv64-gcc && format('-DRISCV64_GCC={0}', env.RISCV64_GCC_DIR) || '' }} \
            -DKANAGAWA_HEAVY_PARALLEL_JOBS=${{ inputs.heavy-parallel-jobs }} \
            ${{ inputs.extra-cmake-args }}

      - name: Reset ccache stats
        run: ccache -z || true

      - name: Disk usage (before build)
        shell: bash
        run: |
          df -h || (wmic logicaldisk get size,freespace,caption 2>/dev/null || true)
          if [ "${{ runner.os }}" != "Windows" ]; then
            sudo du -h -d1 /usr/local | sort -h || true
          fi

      ## Unique workflow steps: Build targets passed as input ##

      - name: Build targets
        shell: bash
        run: |
          # Build each target from the space-separated list
          for target in ${{ inputs.build-targets }}; do
            echo "Building target: $target"
            cmake --build "${{ env.BUILD_DIR }}" --target "$target" --parallel
          done

      - name: Run tests
        if: ${{ inputs.test-targets != '' }}
        shell: bash
        run: |
          # Run each test target from the space-separated list
          for target in ${{ inputs.test-targets }}; do
            echo "Running test target: $target"
            cmake --build "${{ env.BUILD_DIR }}" --target "$target" --parallel
          done

      - name: Upload artifacts
        if: ${{ inputs.artifact-name != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.artifact-name }}
          path: ${{ inputs.artifact-path }}
          if-no-files-found: error

      ## End unique workflow steps ##

      - name: Log ccache stats
        shell: bash
        run: |
          echo "==== ccache statistics ===="
          ccache -s || true
          echo "==========================="

      - name: Reset ccache stats
        if: always()
        run: ccache -z || true

      - name: Disk usage (after build)
        if: always()
        shell: bash
        run: df -h || (wmic logicaldisk get size,freespace,caption 2>/dev/null || true)

      - name: Cleanup build dir & temp caches
        if: always()
        shell: bash
        run: |
          rm -rf "${{ env.BUILD_DIR }}" || true
          rm -rf "$RUNNER_TEMP/.ccache/tmp" || true
          du -sh "$RUNNER_TEMP" || true
