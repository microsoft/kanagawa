# Sandcastle

Generate documentation from annotated Kanagawa source code.

## Table of Contents

* [Goals](#goals)
* [Invocation](#invocation)
* [Documentation and markup](#documentation-and-markup)
  * [Documenting top-level declaration](#documenting-top-level-declaration)
  * [Documenting parts of a declaration](#documenting-parts-of-a-declaration)
    * [Class methods, variables, and callbacks](#class-methods-variables-and-callbacks)
    * [struct, enum, and union fields](#struct-enum-and-union-fields)
    * [Template parameters and function arguments](#template-parameters-and-function-arguments)
  * [Documentation structure](#documentation-structure)
    * [Module description](#module-description)
    * [Hyperlinking](#hyperlinking)
  * [Markup](#markup)
    * [Svgbob](#svgbob)
    * [Anchors](#anchors)
    * [Collapsible Examples](#collapsible-examples)
* [References](#references)

<h2><a href="#table-of-contents" id="goals">Goals</a> <a href="#goals">&para;</a></h2>

Sandcastle is designed to fulfill several goals:

* Generate documentation from Kanagawa modules, extracting API
  documentation from exposed type aliases, functions, classes, etc. The
  generated documentation will encapsulate only the interface that is available
  to the module user.
* Keep the documentation as close as possible to the implementation of the
  API. Sandcastle allows the programmer to write documentation for any entity
  adjacent to the definition of the entity in the source code.
* Documentation annotations are non-intrusive and do not obfuscate the source
  code. Annotations should be lightweight and easy to read and write while
  also supporting basic markdown features.
* Recognize the language scopes and module system. Generated documentation
  should display information important to users.
* Navigation via hyperlinks. Documentation generated by Sandcastle
  makes abundant use of hyperlinks and anchors. Identifiers are linked
  and declarations are anchored including their respective components.
  Furthermore, user-written annotations may contain hyperlinks.
* Produce documentation in multiple formats. Sandcastle supports
  a markdown and html backend. Adding new backends is straightforward and flexible.

<h2><a href="#table-of-contents" id="invocation">Invocation</a> <a href="#invocation">&para;</a></h2>

Sandcastle is invoked from the command line:
```bash
sandcastle [OPTIONS] [FILE]
```
Where each `FILE` is a filename containing a Kanagawa source module.
Files can be absolute paths or relative paths to
the current directory. Use the option `-?` or `--help` to see a list of all
command line options.

The modules specified on the command line are processed together. When one
module refers to an type declared in another module being processed, the documentation
will link to that declaration. The modules should **not** be mutually
recursive. Currently, links to entities that cannot be found will be dead links.

Sandcastle currently only supports generating Markdown and HTML documentation.

<h2><a href="#table-of-contents" id="documentation-and-markup">Documentation and markup</a> <a href="#documentation-and-markup">&para;</a></h2>

Sandcastle recognizes special documentation annotations in the Kanagawa source
file and transforms these into generated documentation. If there are no
annotations, Sandcastle generates documentation that incorporates exposed
type alias, enum, struct, function, and class declarations.

The annotation is a language
comment and is parsed by the Kanagawa compiler using the
`--parse-docs` command-line switch.

<h3><a href="#table-of-contents" id="documenting-top-level-declaration">Documenting top-level declaration</a> <a href="#documenting-top-level-declaration">&para;</a></h3>

The simplest documentation annotation is for a top-level declaration. Suppose
the source file contains the following function:
```cpp
template <typename T>
inline T xor(T a, T b)
{
    return a ^ b;
}
```
Then we can document it like this:
```cpp
//| Return xor of inputs.
template <typename T>
inline T xor(T a, T b)
{
    return a ^ b;
}
```

The annotation begins with the `//|` syntax and applies to the
**following** declaration in the source file. Additionally, Sandcastle
supports writing documentation after the declaration by using `//<`.

```cpp
template
  < typename T //< Type of number to square
  , typename R //< Return type of squared number
  >
inline R square
    ( T x //< Input number
    )
{
    return x * x;
}
//< Square a number
```

Annotations can span several lines and continue until the first non-comment
line in the source file.
```cpp
//| Adds two values of the input type.
// Returns the result as the output type, which might be larger.
// e.g. 3 fits in a uint2, but 3 + 3 does not.
template <typename R, typename T>
inline R add(T a, T b)
{
    return a + b;
}
```
The line comment style `//` requires a single space of margin after the comment
prefix, `|` or `/`, and after each subsequent line.

Annotations can also utilize Kanagawa's multi-line comment style. This style
does not require a single space margin.
```cpp
/*|
Adds two values of the input type.
Returns the result as the output type, which might be larger.
e.g. 3 fits in a uint2, but 3 + 3 does not.
*/
template <typename R, typename T>
inline R add(T a, T b)
{
    return a + b;
}
```

<h3><a href="#table-of-contents" id="documenting-parts-of-a-declaration">Documenting parts of a declaration</a> <a href="#documenting-parts-of-a-declaration">&para;</a></h3>

In addition to annotating a top-level declaration, Sandcastle supports
documenting parts of a declaration.

<h4><a href="#table-of-contents" id="class-methods-variables-and-callbacks">Class methods, variables, and callbacks</a> <a href="#class-methods-variables-and-callbacks">&para;</a></h4>

Class methods and variables are annotated using `//|` in the same way as
top-level declarations. Public members are always displayed. Private
[callbacks](programming-guide.md#callbacks) will always be displayed. All
other private members will be displayed only if they are annotated with a
Sandcastle comment.

```cpp
template <auto Maximum, auto Initial>
class counter
{
public:
    //| Convenient type alias.
    using ctr_t = count_t<Maximum>;

private:
    //| This is displayed in generated documentation.
    ctr_t _first = Initial;

    ctr_t _second = 0; // This will not be displayed.

    (uint32 x) -> uint2 callback; // This will be displayed
                                  // even if it is not annotated.

public:
    //| Returns the current count.
    inline ctr_t count()
    {
        ctr_t result;
        atomic
        {
            result = _first - _second;
        }
        return result;
    }
}
```

<h4><a href="#table-of-contents" id="struct-enum-and-union-fields">struct, enum, and union fields</a> <a href="#struct-enum-and-union-fields">&para;</a></h4>

`struct` fields are annotated in the following styles:
```cpp
template <typename T>
struct optional
{
    //| Pre: valid flag
    bool is_valid /*< Post: valid flag*/;

    //| Pre: underlying value
    T value /*< Post: underlying value*/;
}
```

`enum` fields are annotated in the following styles:
```cpp
enum RGBColor : uint2
{
    //| Red
    RED
    //< Red
,
    //| Green
    GREEN
    //< Green
,
    //| Blue
    BLUE
    //< Blue
}
```

`union` fields are annotated in the following styles:
```cpp
union ExampleUnion
{
    //| Pre: a larger number
    uint8 larger /*< Post: a larger number*/;

    //| Pre: a smaller number
    uint4 smaller /*< Post: a smaller number*/;
}
```

<h4><a href="#table-of-contents" id="template-parameters-and-function-arguments">Template parameters and function arguments</a> <a href="#template-parameters-and-function-arguments">&para;</a></h4>

Individual template parameters and functions arguments are annotated using the
following styles:
```cpp
template
    < //| The type of the elements in the input array.
      typename T
    , //| The length of the input array.
      auto N
    , //| The type of the elements in the result array.
      typename R
    >
inline R[N] map1
    ( //| A function that maps input values to result values.
      (T) -> R fn
    , //| Input array
      T[N] x
    )
{}

template
    < typename T //< The type of the elements in the input array.
    , auto N     //< The length of the input array.
    , typename R //< The type of the elements in the result array.
    >
inline R[N] map2
    ( (T) -> R fn //< A function that maps input values to result values.
    , T[N] x      //< Input array.
    )
{}
```

<h3><a href="#table-of-contents" id="documentation-structure">Documentation structure</a> <a href="#documentation-structure">&para;</a></h3>

The documentation for a module consists of three parts, listed in the order
they appear:

1. The module title and description.
2. The module index list which includes hyperlinks to all locally exposed
   declaration descriptions and re-exposed modules and their declarations.
   The local declaration links appear first and in the order that they are
   listed in the original source code exposition list.
3. A list of all locally exposed declarations and their descriptions in the
   order they appear in the original source code.

Re-exposed declarations will only be displayed in the index section of the
generated document.

<h4><a href="#table-of-contents" id="module-description">Module description</a> <a href="#module-description">&para;</a></h4>

Sandcastle supports documenting a module with a description.
```cpp
/*|
Copyright: (c) Microsoft Corporation. All rights reserved.

A description of this module, possibly containing @some markup@.
*/
module some.name {}
```

<h4><a href="#table-of-contents" id="hyperlinking">Hyperlinking</a> <a href="#hyperlinking">&para;</a></h4>

Sandcastle hyperlinks type identifiers to their respective definitions, either
locally or an imported module. If a type identifier is used and imported from a
module that is not specified on the command-line, but instead included with
`--import-dir`, then a dead link will be created.

<h3><a href="#table-of-contents" id="markup">Markup</a> <a href="#markup">&para;</a></h3>

Sandcastle uses Pandoc's Markdown syntax to format code comments. See the
[Pandoc Markdown manual](https://pandoc.org/MANUAL.html#pandocs-markdown) for more details.


<h4><a href="#table-of-contents" id="svgbob">Svgbob</a> <a href="#svgbob">&para;</a></h4>

Sandcastle supports [Svgbob](https://github.com/ivanceras/svgbob) diagrams
bounded by the `@@` symbol.
```cpp
//|
// @@
// +---+      ,-----\->
// |   |----->|   .-|
// |___|-/  /->---|-|-O
// @@
```
The SVG diagram will be rendered in the generated documentation if user
specifies `--svgbob` on the command line and `svgbob_cli` is installed and
located on environment PATH.

For more information on how to create awesome diagrams see the
[Svgbob specification](https://ivanceras.github.io/content/Svgbob/Specification.html).

<h4><a href="#table-of-contents" id="anchors">Anchors</a> <a href="#anchors">&para;</a></h4>

Include an anchor to link to a point in the documentation which doesn't
correspond to a particular entity. The syntax is `[My anchor]{#label .anchor}`, where "label" is
the name of the anchor.
Link to a custom anchor using the hyperlink syntax: `[link title](#label)`.

See [bracketed spans](https://pandoc.org/MANUAL.html#extension-bracketed_spans)

<h4><a href="#table-of-contents" id="collapsible-examples">Collapsible Examples</a> <a href="#collapsible-examples">&para;</a></h4>

Use the following syntax, [header](https://pandoc.org/MANUAL.html#headings) 4
[strong](https://pandoc.org/MANUAL.html#emphasis) with either "Example" or
"Examples" followed by one or more pairs of an optional paragraph and a code
block, to render a collapsible example code block:
```md
#### __Example__

    some code block
```
renders

<details>
<summary>Example</summary>

    some code block
</details>
<br>
Optionally include some paragraph text before each code block:

```md
#### __Examples__

    code block 1

Case 2

    code block 2
```
renders

<details>
<summary>Examples</summary>

    code block 1

Case 2

    code block 2
</details>

<h2><a href="#table-of-contents" id="references">References</a> <a href="#references">&para;</a></h2>

* [Pandoc](https://github.com/jgm/pandoc#pandoc)
  * [Markdown](https://pandoc.org/MANUAL.html#pandocs-markdown)
